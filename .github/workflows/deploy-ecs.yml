# AWS ECS CI/CD Pipeline for MyTraveler
name: üöÄ Deploy to AWS ECS

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      skip_tests:
        description: 'Skip tests'
        required: false
        default: false
        type: boolean

env:
  AWS_REGION: us-east-1
  ECR_REGISTRY: 416783822569.dkr.ecr.us-east-1.amazonaws.com
  ECS_CLUSTER: mytraveler-clusterr
  ECS_SERVICE: mytraveler-servicee
  FRONTEND_REPO: mytraveler-frontend
  BACKEND_REPO: mytraveler-backend

jobs:
  # ============================================
  # Build and Test
  # ============================================
  build-and-test:
    name: üß™ Build & Test
    runs-on: ubuntu-latest
    
    steps:
      - name: üì• Checkout
        uses: actions/checkout@v4

      - name: üü¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: üì¶ Install Dependencies
        run: npm ci
        continue-on-error: true

      - name: üî® Build Frontend
        run: npm run build
        continue-on-error: true
        env:
          NEXT_PUBLIC_API_URL: http://localhost:8080/api
          NEXT_PUBLIC_PAYMOB_IFRAME: https://accept.paymob.com/api/acceptance/iframes/5404472

      - name: üì¶ Install Backend Dependencies
        run: cd backend && npm ci
        continue-on-error: true

  # ============================================
  # Build and Push Docker Images
  # ============================================
  build-images:
    name: üê≥ Build & Push Images
    runs-on: ubuntu-latest
    needs: build-and-test
    
    steps:
      - name: üì• Checkout
        uses: actions/checkout@v4

      - name: üîê Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: üêò Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: üèóÔ∏è Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: üê≥ Build & Push Frontend
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile.frontend
          push: true
          tags: |
            ${{ env.ECR_REGISTRY }}/${{ env.FRONTEND_REPO }}:${{ github.sha }}
            ${{ env.ECR_REGISTRY }}/${{ env.FRONTEND_REPO }}:latest
          build-args: |
            NEXT_PUBLIC_API_URL=http://localhost:8080/api
            NEXT_PUBLIC_PAYMOB_IFRAME=https://accept.paymob.com/api/acceptance/iframes/5404472
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: üê≥ Build & Push Backend
        uses: docker/build-push-action@v5
        with:
          context: ./backend
          file: ./backend/Dockerfile.prod
          push: true
          tags: |
            ${{ env.ECR_REGISTRY }}/${{ env.BACKEND_REPO }}:${{ github.sha }}
            ${{ env.ECR_REGISTRY }}/${{ env.BACKEND_REPO }}:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # ============================================
  # Deploy to ECS
  # ============================================
  deploy:
    name: üöÄ Deploy to ECS
    runs-on: ubuntu-latest
    needs: build-images
    
    steps:
      - name: üì• Checkout
        uses: actions/checkout@v4

      - name: üîê Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: üìÑ Create Task Definition
        run: |
          cat > task-definition.json << 'EOF'
          {
            "family": "mytraveler-task",
            "networkMode": "awsvpc",
            "requiresCompatibilities": ["FARGATE"],
            "cpu": "1024",
            "memory": "2048",
            "executionRoleArn": "arn:aws:iam::416783822569:role/ecsTaskExecutionRole",
            "taskRoleArn": "arn:aws:iam::416783822569:role/ecsTaskExecutionRole",
            "containerDefinitions": [
              {
                "name": "backend",
                "image": "416783822569.dkr.ecr.us-east-1.amazonaws.com/mytraveler-backend:${{ github.sha }}",
                "portMappings": [
                  {
                    "containerPort": 8080,
                    "protocol": "tcp"
                  }
                ],
                "environment": [
                  {"name": "NODE_ENV", "value": "production"},
                  {"name": "PORT", "value": "8080"},
                  {"name": "DB_TYPE", "value": "postgres"},
                  {"name": "DB_PORT", "value": "5432"},
                  {"name": "DB_NAME", "value": "mytraveler"},
                  {"name": "DB_USER", "value": "mytraveler_admin"},
                  {"name": "REDIS_PORT", "value": "6379"},
                  {"name": "REDIS_HOST", "value": "mytraveler-redis-butsk7.serverless.use1.cache.amazonaws.com"},
                  {"name": "AVIATIONSTACK_BASE_URL", "value": "http://api.aviationstack.com/v1"},
                  {"name": "CORS_ORIGIN", "value": "*"},
                  {"name": "FRONTEND_URL", "value": "*"},
                  {"name": "GOOGLE_CALLBACK_URL", "value": "http://mytraveler.publicvm.com:8080/api/auth/callback/google"},
                  {"name": "GOOGLE_CLIENT_ID", "value": "289466610041-a58cvc8432is5peab14cssoi28ddug3g.apps.googleusercontent.com"},
                  {"name": "GOOGLE_CLIENT_SECRET", "value": "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"}
                ],
                "secrets": [
                  {
                    "name": "DB_HOST",
                    "valueFrom": "arn:aws:secretsmanager:us-east-1:416783822569:secret:/mytraveler/prod/db-host-y2z7d8"
                  },
                  {
                    "name": "DB_PASSWORD",
                    "valueFrom": "arn:aws:secretsmanager:us-east-1:416783822569:secret:/mytraveler/prod/db-password-oYK68R"
                  },
                  {
                    "name": "JWT_SECRET",
                    "valueFrom": "arn:aws:secretsmanager:us-east-1:416783822569:secret:/mytraveler/prod/jwt-secret-Wml0Em"
                  },
                  {
                    "name": "AVIATIONSTACK_API_KEY",
                    "valueFrom": "arn:aws:secretsmanager:us-east-1:416783822569:secret:/mytraveler/prod/aviationstack-api-key-suOXIW"
                  },
                  {
                    "name": "PAYMOB_API_KEY",
                    "valueFrom": "arn:aws:secretsmanager:us-east-1:416783822569:secret:/mytraveler/prod/paymob-api-key-MAvIuX"
                  },
                  {
                    "name": "PAYMOB_INTEGRATION_ID",
                    "valueFrom": "arn:aws:secretsmanager:us-east-1:416783822569:secret:/mytraveler/prod/paymob-integration-id-fus1RK"
                  },
                  {
                    "name": "PAYMOB_HMAC_KEY",
                    "valueFrom": "arn:aws:secretsmanager:us-east-1:416783822569:secret:/mytraveler/prod/paymob-hmac-key-Rg8ACA"
                  },
                  {
                    "name": "PAYMOB_IFRAME_ID",
                    "valueFrom": "arn:aws:secretsmanager:us-east-1:416783822569:secret:/mytraveler/prod/paymob-iframe-id-qbOzwW"
                  }
                ],
                "logConfiguration": {
                  "logDriver": "awslogs",
                  "options": {
                    "awslogs-group": "/ecs/mytraveler",
                    "awslogs-region": "us-east-1",
                    "awslogs-stream-prefix": "backend",
                    "awslogs-create-group": "true"
                  }
                },
                "healthCheck": {
                  "command": ["CMD-SHELL", "wget --spider -q http://localhost:8080/health || exit 1"],
                  "interval": 30,
                  "timeout": 5,
                  "retries": 3,
                  "startPeriod": 60
                },
                "essential": true
              },
              {
                "name": "frontend",
                "image": "416783822569.dkr.ecr.us-east-1.amazonaws.com/mytraveler-frontend:${{ github.sha }}",
                "portMappings": [
                  {
                    "containerPort": 3000,
                    "protocol": "tcp"
                  }
                ],
                "environment": [
                  {"name": "NODE_ENV", "value": "production"},
                  {"name": "PORT", "value": "3000"},
                  {"name": "NEXT_PUBLIC_API_URL", "value": "http://3.236.83.47:8080/api"}
                ],
                "logConfiguration": {
                  "logDriver": "awslogs",
                  "options": {
                    "awslogs-group": "/ecs/mytraveler",
                    "awslogs-region": "us-east-1",
                    "awslogs-stream-prefix": "frontend",
                    "awslogs-create-group": "true"
                  }
                },
                "essential": false
              }
            ]
          }
          EOF

      - name: üìù Register Task Definition
        id: register-task
        run: |
          TASK_DEF_ARN=$(aws ecs register-task-definition \
            --cli-input-json file://task-definition.json \
            --query 'taskDefinition.taskDefinitionArn' \
            --output text)
          echo "task-definition-arn=$TASK_DEF_ARN" >> $GITHUB_OUTPUT
          echo "‚úÖ Registered task definition: $TASK_DEF_ARN"

      - name: üöÄ Update ECS Service
        run: |
          aws ecs update-service \
            --cluster ${{ env.ECS_CLUSTER }} \
            --service ${{ env.ECS_SERVICE }} \
            --task-definition ${{ steps.register-task.outputs.task-definition-arn }} \
            --force-new-deployment
          echo "‚úÖ Service update initiated"

      - name: ‚è≥ Wait for Deployment
        run: |
          echo "Waiting for service to stabilize..."
          aws ecs wait services-stable \
            --cluster ${{ env.ECS_CLUSTER }} \
            --services ${{ env.ECS_SERVICE }} || true
          echo "‚úÖ Deployment complete!"

      - name: üìä Get ECS Task Public IP
        continue-on-error: true
        run: |
          echo "Getting ECS task public IP..."
          
          # Wait a bit for task to start
          sleep 60
          
          TASK_ARN=$(aws ecs list-tasks --cluster ${{ env.ECS_CLUSTER }} --service-name ${{ env.ECS_SERVICE }} --query 'taskArns[0]' --output text 2>/dev/null || echo "None")
          
          if [ "$TASK_ARN" = "None" ] || [ -z "$TASK_ARN" ]; then
            echo "‚ö†Ô∏è No running tasks found. Check ECS Console for task status."
            echo ""
            echo "üîç Debug: Check the ECS Console for errors:"
            echo "   1. Go to ECS ‚Üí Clusters ‚Üí ${{ env.ECS_CLUSTER }}"
            echo "   2. Click on Service ‚Üí ${{ env.ECS_SERVICE }}"
            echo "   3. Check 'Tasks' tab and 'Events' tab for errors"
            echo ""
            
            # List any stopped tasks for debugging
            echo "Recent task activity:"
            aws ecs list-tasks --cluster ${{ env.ECS_CLUSTER }} --service-name ${{ env.ECS_SERVICE }} --desired-status STOPPED --query 'taskArns' --output text || true
            exit 0
          fi
          
          echo "Found task: $TASK_ARN"
          
          ENI_ID=$(aws ecs describe-tasks --cluster ${{ env.ECS_CLUSTER }} --tasks $TASK_ARN --query 'tasks[0].attachments[0].details[?name==`networkInterfaceId`].value' --output text 2>/dev/null || echo "")
          
          if [ -z "$ENI_ID" ]; then
            echo "‚ö†Ô∏è Could not find network interface. Task may still be starting."
            exit 0
          fi
          
          PUBLIC_IP=$(aws ec2 describe-network-interfaces --network-interface-ids $ENI_ID --query 'NetworkInterfaces[0].Association.PublicIp' --output text 2>/dev/null || echo "")
          
          if [ -z "$PUBLIC_IP" ] || [ "$PUBLIC_IP" = "None" ]; then
            echo "‚ö†Ô∏è No public IP assigned. Check if 'Auto-assign public IP' is enabled."
            exit 0
          fi
          
          echo "==================================="
          echo "üéâ DEPLOYMENT COMPLETE!"
          echo "==================================="
          echo ""
          echo "üåê Frontend: http://$PUBLIC_IP:3000"
          echo "üîß Backend API: http://$PUBLIC_IP:8080/api"
          echo "üì¶ Image Tag: ${{ github.sha }}"
          echo ""
          echo "==================================="

